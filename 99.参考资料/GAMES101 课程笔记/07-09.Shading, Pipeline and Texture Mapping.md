# Shading: Shading,Pipeline and Texture Mapping

# 7.1 目前的进度和局限

![Rotating Cubes](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-105.png-mymark)

能够用上面的方法绘制场景，即可做出如图的效果。但这样是不够的。我们想得到下面的效果

![Rotating Cubes Expected](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-106.png-mymark)

为什么会这样呢？为什么“相同”颜色的方块的每一面颜色不一致呢？容易发现，是环境光的影响。我们看到的物体画面是由物体本身和环境光共同作用得到的结果。所以需要考虑环境光。这个共同作用的方式，则体现出了物体的材质。

# 7.2 Shading 是什么

![Shading: Definition](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-107.png-mymark)

而 Shading 在本课中则对应着将材质应用于物体本身的过程。

# 7.3 Blinn-Phong 模型介绍

![A Simple Shading Model](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-108.png-mymark)

Blinn-Phong 是经验总结下的容易实现的材质模型。其原理来自于观察：当光源和观察者的方向接近时，物体的颜色会变得更亮。而当光源和观察者的方向相反时，物体的颜色会变得更暗。

![Perceptual Observations](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-109.png-mymark)

类似于绘画中的三大面。可以把物体表面分为高光区域、漫反射区域、环境光区域。

![Shading is Local](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-110.png-mymark)

需要注意的是，Shading 有局部性，只关心每个三角形本身，不关心三角形相互的作用，

# 7.4 Blinn-Phong 漫反射

![Lambertian (Diffuse) Shading](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-111.png-mymark)

Blinn-Phong 模型中，漫反射的颜色受到三个部分影响

- 材料的固有色，对应一个系数（可为颜色向量）$k_d$
- 反光点和光源的距离光源，距离越远亮度越底，对应于 $𝐼/𝑟^2$
- 表面法线与光线的夹角，夹角越大则单位面积能反射的光子理应越少，一旦大过 $𝜋/2$ 则意味着背光，不再漫反射。于是对应于 $𝑚𝑎𝑥(0,𝑛∗𝑙)$

![Lambertian (Diffuse) Shading](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-112.png-mymark)

仅利用漫反射模型，且单一灰阶的固有色即可渲染出上面的效果。

# 8.1 Blinn-Phong 高光

![Specular Term](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-114.png-mymark)

再考虑高光项。高光对应于镜面反射，摄像机越接近光源的镜面反射的出方向，则应接受到越强的镜面反射光。度量这个“接近度”有一个聪明的比较容易的计算的方法，是比较光源方向和摄像机方向的中间方向（很容易计算）和法线方向的夹角，夹角越大则越不接近。

且对于这个接近度可以取一个次数 $p$，使整体更容易调整，且接近想要的效果。

![Cosine Power Plots](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-115.png-mymark)

$p$ 越高，高亮区域越小。通常而言会用到 100 ～ 200。

![Blinn-Phong](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-116.png-mymark)

加入了高光项后，可以得到上图效果，且可以看出两个参数在调整时对结果的影响。

# 8.2 Blinn-Phong 环境光

![Ambient Term](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-117.png-mymark)

最后，对于暗部，并不希望全黑，所以可以加入环境光项，当然，并没有办法保证有光，也不可能环境光处处相同，所以这只是个不符合物理的趋近方法

![Blinn-Phong Reflection Model](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-118.png-mymark)

最后综合 漫反射、高光、环境光 三项后可以得到上图效果。

# 8.3 Shading 频率

![Shading Frequencies](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-119.png-mymark)

同样是应用 Blinn-Phong，也可以由于面向对象不同得到不同结果，上方三张图依次对应于

- 低频：面向三角形
- 中频：面向顶点，三角形内部应用重心坐标差值
- 高频：面向像素

![Shade each triangle](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-120.png-mymark)

面向三角形的 Shading 计算量最小。但对于不够高面又光滑曲面的物体而言会不再光滑。

![Shade each vertex](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-121.png-mymark)

对顶点着色，并应用差值：

![Shade each pixel](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-122.png-mymark)

对每个像素着色。这里的 Phong Shading 对应于着色频率，而非 Blinn-Phong 着色模型。

![Shading Frequency: Face, Vertex or Pixel](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-123.png-mymark)

这几种着色频率对应足够高面的模型而言表现是近似的。所以如果足够多面，应优先选择更低频的着色方式，减少计算量。

![Defining Per-Vertex Normal Vectors](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-124.png-mymark)

对逐顶点着色而言，是需要获得顶点的法线的。可以采用相邻三角形法线的简单平均，或者根据三角形面积加权平均。

![Defining Per-Pixel Normal Vectors](https://pphkpublicbucket.oss-cn-hongkong.aliyuncs.com/ppblog/2021/02/image-125.png-mymark)

对逐像素着色而言，则需要获得每个像素的法线方向，通常使用自己和附近面的法线用一些方式加权平均。

# 8.4 渲染管线
