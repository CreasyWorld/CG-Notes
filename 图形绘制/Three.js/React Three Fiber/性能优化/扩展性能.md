# React Three Fiber 扩展性能

运行 WebGL 可能相当昂贵，这取决于你的设备有多强大。为了减轻这种情况，特别是如果你想让你的应用程序适用于各种设备，包括较弱的设备，你应该研究一下性能优化。本文将介绍其中的几项。

# 按需渲染

three.js 应用程序通常以每秒执行 60 次的游戏循环方式运行，React Three Fiber 也不例外。当你的场景中有不断移动的部件时，这是很好的。这通常是最耗费电池和使风扇旋转起来的原因。但是如果你的场景中的移动部件被允许休息，那么继续渲染就会造成浪费。在这种情况下，你可以选择按需渲染，只有在必要时才进行渲染。这可以节省电池，并使嘈杂的风扇得到控制。在全屏中打开下面的沙盘，并查看开发工具，你会发现在没有任何事情发生的时候，它是完全空闲的。只有当你移动模型时，它才会进行渲染。

![沙盘](https://docs.pmnd.rs/_next/image?url=https%3A%2F%2Fcodesandbox.io%2Fapi%2Fv1%2Fsandboxes%2Fwvgxp%2Fscreenshot.png&w=3840&q=75)

你需要做的就是把 canvas frameloop 属性设置为 demand，每当它检测到整个组件树上的 Props 变化时，它就会渲染框架。

```js
<Canvas frameloop="demand">
```

一个主要的注意事项是，如果树中的任何东西突变了道具，那么 React 就不能意识到它，显示就会变味。例如，相机控件只是抓取到相机并突变其值。在这里你可以使用 React Three Fiber 的 invalidate 函数来手动触发帧。

```js
function Controls() {
  const ref = useRef()
  const { invalidate, camera, gl } = useThree()
  useEffect(() => {
    ref.current.addEventListener('change', invalidate)
    return () => ref.current.removeEventListener('change', invalidate)
  }, [])
  return <orbitControls ref={ref} args={[camera, gl.domElement]} />
```

一般来说，只要你需要渲染，就可以调用 invalidate。

```js
invalidate();
```

# Links

- https://docs.pmnd.rs/react-three-fiber/advanced/scaling-performance#triggering-manual-frames
